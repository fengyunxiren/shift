#使用自动多对多并行传输的高性能、高可靠性的文件传输工具
**简介**：`Shift`是一个高性能的本地以及远端文件传输的轻量级框架脚本，它拥有应对各种错误的复原能力。Shift支持多种文件传输协议，可以自动为参与传输的每一对主机选择最合适的机制以适应具有不同软件和网络访问限制的异构客户端。通过从客户端和服务端采集文件系统信息以检测文件系统的等价性和能否路径重写，这样可以使客户端根据负载和可用性自动并发完成将单个或多个文件传输到多个服务器上。通过消除单点的故障，可以同时提升文件传输的性能和可靠性，突破了单一系统的瓶颈。通过哈希密码表保证端对端的完整性，在出错的时候只需将错误的部分重传。本文描述了`Shift`设计和应用方法以及提升文件传输性能和可靠性的设计细节。
##1 介绍
在高端计算环境下，从计算资源里远程传输大数据文件是非常常见的事情，由于用户分布在不同的机构中，需要将输入数据传入计算机进行处理，然后将输出数据传回进行进一步分析。当新的文件系统上线或者现存的文件系统存储失衡时，管理员需要优化资源配置，这时，同样的数据在本地不同的文件系统之间的传输也会变得非常频繁。在以上情况中，文件从资源端传到目的端都需要经过许多器件，在这之中，有非常多的机会来优化传输性能，它与你犯错误的机会一样多。我们工作的重点是研发自动的、高性能的、高可靠性的、简单易用、容易部署支持上面两种传输情况的传输工具。
目前已经存在许多提供高稳定性和（或者）高性能的文件传输工具，但是它们之中大多数都不支持本地的文件传输，需要特殊的安全模式和或者传输工具，不方便个人用户的部署，而且没有优化到最佳性能。本文介绍了`Shift`传输工具，一个全新的文件传输框架：*S*elf-*H*ealing *I*ndependent *F*ile *T*ransfers。`Shift`通过运用各种技术，提供了一个高性能、高适应性的本地和远程的文件传输方法。这些技术包括通过哈希密码保持端对端的完整性，传输限制以防止计算机资源被耗尽，基于负载和可用性让传输资源达到平衡，支持在多个资源端和目的端的并行文件传输，从而增加冗余和提升性能。此外，`Shift`给用户的操作环境做了最小的假设，通过特别设计，能够容纳各种各样的异构环境。`Shift`在文件传输的可靠性和自动的单个或多个文件的并行传输上比任何其它命令行传输应用都要优越，同时也非常方便个人用户或者团队部署。
`Shift`包含一个客户端和一个管理组件。图1文件传输的顺序，展示了歌组件的位置。一个单一的文件传输可能包含许多不同的文件操作，如创建目录，复制文件，修改属性，计算校验码等，初始客户端执行操作包括给出传输文件以及将它们在管理端初始化。这个客户端与其它的复制客户端动态连接，然后向管理端请求一系列的操作，并试着完成这些操作，并将结果返回给管理端，客户端会根据可行性，性能和当前系统特性利用不同的工具完成文件操作。本文后面会详细讨论文件的传输过程。
`Shift`的核心依赖`Perl`语言和直接或间接利用如`SSH`公共秘钥等非交互式身份验证的`SSH`来访问远程端.客户端不需要提供`SSH`访问，但是，如果这样，`Shift`的并行传输的特性将不可用。`Shift`同时支持手动设置密钥对和单点登陆`SSH`。客户端首先用一个轻量级的身份验证和授权框架`Mesh`进行测试，`Mesh`提供利用`SSH`密钥对进行单点登陆的方法。通过少量修改临时处理凭证，客户端便可支持其它的身份验证框架如`GSI`。
本文结构如下，第二部分展示相关的工作，第三部分和第四部分介绍`Shift`的管理端和客户端，第五部分详细描述传输时的并发和负载平衡，最后一部分为总结和下一步工作计划。
##2 相关工作
`cp`和`scp`分别是本地和远程文件传输的标准方法。然而也存在许多其它的文件传输工具，能够提供更好的性能和（或者）可靠性。`BbFTP`是一个支持多种`TCP`流的远程文件传输工具，它能够配置缓冲区的大小以提高文件传输的性能，同时有一个简单的重试机制来保证传输的可靠性。`Rsync`同时支持本地和远程传输，可以通过部分传输同步资源端和目的地端的文件，它通过最小化传输文件，提升了传输性能，同时通过纠错机制提高了文件传输的可靠性。`GridFTP`实现了`BbFTP`和`Rsync`大部分功能，并且有更容易配置的试错机制，还额外增加了提升性能的传输方法如基于`UDP`的数据流，部分文件传输，和在多台服务器之间的数据传输。`Mcp`是一个高性能的本地复制工具，支持多线程的单个或多个文件的复制，它支持多节点，双缓冲，以及集成了并行的哈希运算。在可行的情况下，`Shift`可以利用以上任何一种工具来提升性能。
许多工具通过修改现存的传输工具来提升性能和（或者）可靠性。`Lim`等工具用包含`GridFTP`的`Naradabrokering`作为一种更可靠的通信媒介。`Sultanate`等通过在文件后面添加数字签名来检测在`FTP`传输中文件坏点出现的位置。如果坏点位置检测出来，只需要重新传输该文件的一小部分（`Shift`同样支持该功能）。然而，由于需要同时修改客户端和服务端的软件，这个工具部署起来比较困难。`HPN-SSH`是`OpenSSH`的一个增强版本，通过实现动态调整`SSH`服务端和多线程运行`AES-CRT`秘钥使得传输性能得到了大幅度提升，`HPN-SSH`需要通过修改客户端和服务器端来达到最佳性能，两端的修改都不会影响`SSH`的兼容性。
其它的工具（包括`Shift`）利用现存的传输工具来构建模块来提升性能。`Globus Toolkit`的文件可靠性传输服务`RFT`通过增加第三方包`GRidFTP`从中央服务器发起传输来提升传输的可靠性。`RFT`最初的设计只支持单点错误排查。`Basney`和`Duda`通过运行多个`RFT`实例来提供在故障时以及`RFT`同步传输时的容错能力。`gLite File Transfer Service`（FTS）是一个构建在`GridFTP`和`RFT`以及其它服务之上的可靠的文件传输工具。`FTS`跟踪和监视第三方基于低层次服务的所有文件操作。
`RFT`和`FTS`提升了传输工具的弹性，它们用的第三方传输工具对许多机构的安全模式来说，都不适合。`Stork`是一个类似与`Shift`的可靠的数据移动框架。它提供本地传输，在多任务情况下的自动选择能力和保证端对端完整性的功能。`Stork`需要`GSI`认证服务的长时间运行，然而这样的要求对个人部署并不实际，甚至对一个机构来说都比较难实现。
当只有一个文件资源存在的时候，文件资源的传输会经常出现单点传输失败的情况。复制管理服务如`Reptor`能够方便追踪和传输一个文件的多个传输副本，来提供数据冗余以及对特定文件资源进行优化。`Replica Avare RFT`是`RFT`的一个扩展，它可以在单文件传输中复制多个文件副本传输来提升容错能力。点对点网络文件传输协议如`BitTorrent`提供类似功能，在客户端可以为一个文件建立多个数据流来最大化低宽带环境下的网络资源利用率，并且支持并行的哈希运算来检验文件每一部分的完整性。`GridTorrent`结合点对点传输功能和`GridFTP`的传输速度来实现高性能的文件共享。因为个人用户的数据和（或者）已经在本地文件系统里的数据并不会大量的复制到其它地方，所以，`Shift`更专注于为一个文件创建更多的访问端口，而不是寻找更多的同样资源。
##3 Shift管理
`Shift`提供一个轻量的命令行管理工具，通过这两个基本函数方便了对文件操作的集中追踪，这两个函数将在下文介绍。`put()`函数可以为任务添加操作或者修改已存在的操作的状态，`get()`函数可以检索任务的操作。管理器在图1中用虚线标示出来，它可以根据用户的需要部署在任意一台客户端上，或者远端主机上，或者一台专门用来存储冗余数据的主机上。除了跟踪以外，管理器还提供文件的传输状态和传输的性能，用户可以手动查询或者通过邮件自动获取。
`Shift`使用日志结构的平面文件模型来存储追踪数据，它将对其它组件如数据的依赖性降到最低，从而降低了复杂度和减少了故障发生的概率。追踪数据中的每一行都记载了一个文件操作的类型（如`cp`，`mkdir`等），参数，发起操作的源主机，运行时间，文件大小，状态和一个日志消息。文件操作的状态被`put()`函数添加在日志文件中，状态包括以下五个，*do/doing/redo/done/error*。同一个操作可以出现在多个日志文件中，也可以在一个日志文件中出现多次，但是存储的成本由操作的次数和重新配置的可能性控制。这个模型中`put()`函数的时间复杂度为O(1)，并且通过数据重写最大程度的减少了因为断电和故障导致的损失。
每个小的元数据文件为文件传输记录的项目记录了如使用者在log文件中最后一次使用的位置，每个状态操作的个数量等，通过`get()`函数就可以检索到如do/redo在记录中最后出现的位置，并且可以知道下个文件操作是什么。表1给出了`put()`和`get()`函数不同更新规模下的时间消耗，当操作数量到十亿级别时，时间成本会非常高，但这在实际情况种不会遇到，因为这会降低检查故障点的有效性。`get()`函数比`put()`函数的时间成本要高，这是因为在执行`get()`函数时会进行一系列的高级运算，这将会在第五部分详细描述。在没有共享的文件系统的冗余管理配置中，跟踪数据必须保持同，这个可以通过标准的机制来实现，如`Rsync`通过获取管理器的可配置的同步标记来实现。表2展示了`Rsync`通过`put()`从不同的数量的现存操作中添加不同数量文件操作所花费的时间。可以看出即使在十亿级别的数量，操作所花费的时间也比较小。
##4  Shift的客户端
用户与`Shift`交互的客户端由一个轻量级的命令行客户端实现，它的使用方法和`cp`、`scp`基本一样，并实现了它们的大多数操作选项，这让每一个Linux/Unix用户使用起来都非常自然。
###4.1 初始化
当客户端请求从一个地方复制文件到另外一个地方，传输便开始启动。文件操作在初始化阶段得到独立计算，并且文件的操作和文件处理同时进行，而且允许目录遍历迅速完成而不是将目录遍历和文件传输捆绑在一起。本地的文件操作直接使用递归遍历计算，而远端的文件操作使用`SFTP`协议的操作功能进行计算。表3展示了在不同场景下初始化一个递归式传输所花费的时间。可以看出，本地的花费的时间不多，但是在高延迟的`WAN`连接下，远端所花费的时间比较多，通过一个可选的辅助脚本调用`SSH`来实现通过本地计算实现远端的初始化,可以极大的降低该时间成本。
操作通过`put()`函数递交给管理端，它给文件传输建立一个唯一的标识符，并将其同步备份其它管理端，并在随后的操作中将标识符返回给客户端。当初始化完成，客户端在用户的周期性任务中插入一个接口以周期性检查文件的传输状态。当一个传输进程无法检测到，客户端便会自己周期性的启动该进程。因此，当客户端或者它所属的系统崩溃，传输任务最终还是会被重新启动。当管理端终止任务时，客户端会将周期性的任务删除。在没有周期性任务的系统中，会提供相类似的功能，这将在第五部分详述。
###4.2 多个文件传输
在初始化期间，利用不同的文件传输协议，通过`get()`函数创建客户端进程来从管理端检索批量的文件操作。`Shift`支持各种传输协议。在`Perl`和`SSH`的基础上，`Shift`自身包含并可以使用`Perl`自身集成的相当于`cp`的命令，在远程拷贝时，`Shift`便使用类似于`SFTP`和`FISH`的协议。在可行的情况下，`Shift`会自动选择性能最好方法。目前这些选择包括在本地传输时的`Mcp`，和远端传输的`BbFTP`和`GridFTP`以及远端传输和本地传输都能用的`Rsnyc`。
对每一个支持的传输协议，`Shift`都知道如何高效的传输一批文件，如何检测错误，以及错误是否能够恢复。`Shift`能够以同样的方式支持其它的命令行传输工具。根据预估性能顺序，传输时会动态的为每一批文件选择性能最高的传输方法。预估性能取决于每一批文件的大小。在传输之前，会进行一个小文件的传输测试，以保证最后的传输的可行性和正确性。不同工具的传输性能会在第5部分给出。
###4.3 端对端的完整性
为了检测可能在文件遍历时不同组件可能产生的坏点，`Shift`在传输成功时通过计算源端和目的端文件的哈希表了检测端对端的完整性。相匹配的哈希值确保文件在传输过程中没有发生错误。如果传输工具支持（如`Mcp`和内建的传输工具），`Shift`允许资源端的哈希计算成为传输文件的一部分。这样资源端从磁盘中读取数据到缓存区时，哈希计算可以重复使用，从而提高了传输的性能。与那些只验证从网络上传来的位字节的传输工具不同，`Shift`验证存储在目标盘里的位字节，以保证真实的端对端的验证。
传统上来说，不同的哈希值表明在文件传输的过程中文件的某些部分已经损坏。而`Shift`提供了一个哈希树来判断坏点所在的位置在哪个范围。这种方法的性能与标准的`md5sum`相当，并且兼容`Msum`，`Msum`是当在可行的情况下，`Shift`用来提升哈希计算性能的一种校验方法。当检测到坏点时，仅需要重新发送文件的坏点部分。`Mcp`和`GridFTP`本身支持这种部分文件传输，它们也内建在其它传输工具中以实现该功能，文件部分传输以类似的方式被支持。也就是说，当传输中断时，`Shift`会判断源端与目的端文件的不同，并据此继续传输，验证完整性的传输性能会在第5部分展示。图2展示了本地传输部分坏点出现，以及各种错误出现时，`Shift`的恢复机制。可以看出`Shift`能将传输不同场景中自动恢复。
##5 多主机并发传输
用户最初选择的系统的传输过程的性能和可靠性并没有得到优化。可能主机并没有处理文件单点故障的能力。通过引入许多等效的主机一起传输，甚至当原始路径发生错误，文件传输也能够完成。并行传输提升了总的CPU个数，内存，I/O带宽和网络带宽，这使得当每个组件都正常时，传输性能得到了很大的提升。
###5.1 多文件并行传输
任何备用的客户端或远端的服务器必须给予初始的客户端或远端服务器访问权限。远端文件系统的等价性来源于部署的用户或组织通过周期性调用附带工具获取的信息。客户端在初始化过程中通过`mount`命令逐步的收集文件信息并将其传递给管理端来决定客户端的并行行为。在典型的集群环境下并行是最有效的传输方法，登陆用户将分布在相等价的前端中，因此，随着时间的推移，客户端环境完整的情况会随着`Shift`的使用慢慢建立。
客户端的并行发生在`get()`函数的进程期间，如果有足够的任务要做，管理端会寻找相当的主机来访问客户端的文件系统，这些文件系统的信息在初始化的过程中已经传递给管理端了。然后客户端将自己分成相同多的副本来让这些主机通过`SSH`访问。如果基于主机的验证不被支持，而`SSH`代理与用户交互会话可用于验证时，所有的副本验证通常会在第一次调用`get()`时出现。副本客户端立即将自己加入到计划任务中，并在使用`get()`和`put()`函数进行操作之前，与`SSH`会话断开联系。由于每台主机上的挂载点可能不同，路径会根据管理端提供的文件系统信息重写。远端主机此时也通过返回备用远端的路径进行并行处理。
图3和图4展示了远程传输和本地传输（内建工具标有*）在传输小文件（10244MB）和大文件（641GB）时，在不使用`Shift`的一个主机上和使用了不同数量的并行主机的`Shift`上的传输性能。图5和图6展示了同样情况下使用`Msum`哈希算法验证文件完整性的传输性能的变化。远程传输在`GPFS`和`Lustre`文件系统之间，两个前端集群，分别为为8核2.8/3.0 GHz Xeon Westmere/Harpertown CPU 和 1 Gb/s 的`NICs` ，拥有10 Gb/s的网络连接，每台机器上都安装了`HPN-SSH`。本地传输在`Lustre`文件系统之间，CPU为3.0 GHz的Xeon Harpertowns处理器。
`Shift`在使用`Mcp`传输本地小文件时增加了很小的开销，传输在其它主机有时间参加之前就已经完成。可以看出并行传输的性能比`Shift`利用的传输工具或者本地的传输工具性能更优越。这种优势实现于在每次客户端初始化的时候，它的主机信息都会自动连续的提供给管理端。验证需要密集的cpu计算，会导致增加许多开销，但是在传输数据的开销比哈希计算的开销小很多的时候，不会影响传输速度。
###5.2  单个文件的并行传输
在上一节提到的多文件传输技术中，可以将多个文件分成大致相等的批次来传输以最大化并行客户端的资源利用。少数非常大的文件传输会导致某几个客户端一直在传输大文件而其它的客户端却闲置起来的不平衡状态。为此，`Shift`还支持将单个文件分成许多小的块，让后再使用并行的方法传输。
这是利用了部分文件传输的功能。`Mcp`和`GridFTP`都支持传递一个文件的一部分在给定文件偏移量和传递部分的长度的情况下进行传递。这个功能也被通过使用标准的系统寻找，读，写，调用，通信等功能内建到`SFTP/FISH`的本地远程传输中。文件尺寸在一个分界点以上时，就会被管理端分成许多小块然后独立的通过适当的工具传输。图7展示传输一个64GB大小文件时这种方法带来的优势。可以看出，除了`Mcp`外，利用单文件的并行传输方法可以使传输效率比原始方法提升80%左右。`Mcp`由于I/O的限制使得其在部分文件传输时性能出现显著降低。这是一个非预期的bug，但是这对单个主机传输文件的性能并没有影响。通常情况下，不管原始文件的尺寸有多大，`Shift`都可以利用单个文件并行传输的能力使得客户端的资源得到充分利用和平衡。这一功能还允许在单个主机上大文件拥有足够多的检查点。
###5.3  负载平衡
单用户可以通过并行运算来极大的提升传输性能，如果所有用户都使用并行传输将会导致资源紧张。`Shift`提供了不同的方法来平衡分配负载和降低整个网站的负载。`get()`函数处理过程中，会在每次调用管理端时，加载客户端传过来的信息,根据所有的正在传输的任务，实现负载平衡。管理端会根据接收到的负载信息，根据用户给CPU，I/O，网络和磁盘的利用率来决定是否将客户端进入休眠状态。在并行传输期间，高负载的客户端将会被控制传输率，从而将任务平衡到低负载的客户端。
接下来，管理端会基于全局负载和负载分配公平与否来决定客户端是否需要进入睡眠状态。`Shift`基本策略是允许客户端在最初并行传输时请求尽可能多的资源，因为信用凭证可能在调用后的很短一段时间内失效（如`SSH`代理只有在用户登陆期间可用）。然而，客户端的实际资源是由管理端分配的，它是集中部署的，管理端根据客户端信息将自己的信息加载给每一个传输者。如果传输的负载超过了站点的处理能力，足够多的客户端将会进入休眠状态，直到负载下降到可以接受的水平，为了保证在高负载情况下的公平，客户端将被循环使用以保证在另外一个用户拥有两个客户端之前，每个用户都有一个客户端。
一旦客户端需要继续使用时，管理端会决定远端主机对应下一批次的操作的等效路径。负载最低的主机将会被选择，然后在返回到客户端之前，远端的路径会转变为所选主机的挂载点。使用这种方法，`Shift`可以使未利用的资源的到充分利用，同时又会防止因为过分利用而使得性能降低。
##6 总结和未来计划
本文描述了`Shift`，一个能够自我修复的独立的文件传输框架。`Shift`使用一个管理端跟踪在文件传输过程中所有文件操作的状态。管理端通过远端文件系统的信息和客户端提供的信息来找到客户端和远端文件系统等效访问的方法。如果找到了，客户端会复制多个副本对应多个远端主机。通过自动选择传输方法和验证方法，`Shift`适用与多客户端的多个文件传输。
`Shift`替换了传统中容易在客户端和远端传输中出错的传输方法，拥有高并行的传输，并且通过多种冗余和恢复机制，防止文件在传输时出错。客户端或者远端主机断电或者断网导致的单点错误可以通过错误归类恢复的智能恢复机制来修复错误。通过多种技术，`Shift`使用非常容易部署的客户端和管理端来聚集资源来保证传输的高性能和高可靠性。在未来，`Shift`将会开源。
未来的工作有许多方向。目前在文件传输时的哈希计算验证的顺序为首先为每个文件在资源端验证一遍，然后再在目的端验证一次。最理想的情况是，所有的哈希计算都在并行的时候完成并在随后进行比较，这样可以减少一半的哈希计算。对于其它传输工具的支持也需要进一步研究。
